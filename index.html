<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR4UPLOAD - History & Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#6366f1',
                        accentHover: '#4f46e5'
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        
        .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%236366F1FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s ease;
        }
        .upload-box:hover, .upload-box.dragover {
            background-color: rgba(99, 102, 241, 0.12);
            transform: scale(1.015);
            cursor: pointer;
        }
        .uploading {
            cursor: wait !important;
            opacity: 0.75;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-x-hidden">

    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-10 left-10 w-72 h-72 bg-accent/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-10 right-10 w-96 h-96 bg-purple-600/20 rounded-full blur-[100px]"></div>
    </div>

    <div class="w-full max-w-md flex flex-col gap-6">
        
        <div class="bg-card/80 backdrop-blur-md p-6 sm:p-8 rounded-3xl shadow-2xl border border-slate-700/50 z-10">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-black tracking-tighter text-white mb-1">
                    AR4<span class="text-accent">UPLOAD</span> <span class="text-xs font-normal text-slate-500 ml-1">v2.0</span>
                </h1>
                <p class="text-slate-400 text-xs">Simpel. Cepat. Ada riwayatnya.</p>
            </div>

            <div id="config-warning" class="hidden mb-5 p-4 bg-red-500/10 border border-red-500/40 rounded-xl flex items-start gap-3 text-sm">
                <i class="fas fa-exclamation-triangle text-red-400 mt-1 text-xl"></i>
                <div class="text-red-200">
                    <strong>Config belum diisi!</strong><br>
                    Isi <code>SUPABASE_URL</code> & <code>KEY</code> di script paling bawah.
                </div>
            </div>

            <div id="view-upload" class="transition-all duration-300">
                <label for="file-input" id="drop-zone" class="upload-box w-full h-56 rounded-2xl flex flex-col items-center justify-center group relative">
                    <div class="bg-slate-800/80 p-4 rounded-full mb-3 group-hover:bg-slate-700 transition-colors">
                        <i class="fas fa-cloud-arrow-up text-3xl text-accent animate-bounce-slow"></i>
                    </div>
                    <h3 class="text-white font-bold text-lg">Drop / Klik disini</h3>
                    <p class="text-slate-400 text-xs mt-1">Max 50MB</p>
                    <input type="file" id="file-input" class="hidden">
                </label>
            </div>

            <div id="view-progress" class="hidden flex flex-col items-center py-4">
                <div class="w-full bg-slate-800/60 p-4 rounded-xl border border-slate-700 mb-5 flex items-center gap-4">
                    <div class="bg-accent/20 p-3 rounded-lg text-accent">
                        <i class="fas fa-file-alt text-xl"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="file-name" class="text-sm font-medium text-white truncate">nama_file.zip</p>
                        <p id="file-size" class="text-xs text-slate-400 mt-0.5">0 MB</p>
                    </div>
                </div>

                <div class="w-full space-y-2">
                    <div class="flex justify-between text-xs text-slate-300">
                        <span id="status-text">Mengunggah...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 h-2.5 rounded-full overflow-hidden shadow-inner">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-accent to-purple-600 w-0 transition-all duration-200 ease-out"></div>
                    </div>
                </div>
            </div>

            <div id="view-result" class="hidden pt-2 animate-fade-in">
                <div class="text-center mb-5">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500/15 rounded-full mb-3 text-green-400 border border-green-500/30">
                        <i class="fas fa-check text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Upload Sukses!</h3>
                </div>

                <div id="preview-container" class="hidden mb-4 rounded-xl overflow-hidden border border-slate-700 bg-slate-900/50 relative group">
                    <img id="image-preview" src="" class="w-full h-32 object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">Preview</span>
                    </div>
                </div>

                <div class="bg-slate-900 p-1.5 rounded-xl border border-slate-700 flex items-center pl-3 mb-4">
                    <input type="text" id="result-link" readonly 
                        class="bg-transparent w-full text-xs text-slate-300 focus:outline-none truncate mr-2"
                        placeholder="...">
                    <button onclick="copyToClipboard()" class="bg-accent hover:bg-accentHover text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors flex items-center gap-1.5 whitespace-nowrap">
                        <i class="fas fa-copy"></i> Salin
                    </button>
                </div>

                <button onclick="resetApp()" class="w-full py-2.5 text-slate-400 hover:text-white hover:bg-slate-800/50 rounded-lg transition-all text-sm border border-transparent hover:border-slate-700">
                    <i class="fas fa-redo mr-2"></i> Upload lagi
                </button>
            </div>
        </div>

        <div class="bg-card/80 backdrop-blur-md rounded-3xl shadow-lg border border-slate-700/50 overflow-hidden flex flex-col max-h-80">
            <div class="p-4 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/30">
                <h2 class="text-sm font-bold text-slate-200 flex items-center gap-2">
                    <i class="fas fa-history text-accent"></i> Riwayat Upload
                </h2>
                <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300 transition-colors" title="Hapus Semua">
                    Bersihkan
                </button>
            </div>
            
            <div id="history-list" class="overflow-y-auto p-2 space-y-2">
                <div class="text-center py-8 text-slate-500 text-xs italic" id="empty-history">
                    Belum ada riwayat upload.
                </div>
            </div>
        </div>

    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-3 rounded-xl shadow-2xl border border-slate-700 flex items-center gap-3 transform -translate-y-24 opacity-0 transition-all duration-300 z-50">
        <i id="toast-icon" class="fas fa-info-circle text-lg"></i>
        <span id="toast-msg" class="text-sm font-medium">Notif</span>
    </div>

    <script>
        // ==========================================
        // CONFIG
        // ==========================================
        const SUPABASE_URL = 'https://owivtazpjnkbncfwmitk.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93aXZ0YXpwam5rYm5jZndtaXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MTc2MjUsImV4cCI6MjA4NDI5MzYyNX0.nCz4yDlg-iPOZfHrrQHU5tvlDTZJ2HpXWJMGXVPYVsI'; 
        const BUCKET_NAME = 'media';
        // ==========================================

        const { createClient } = supabase;
        let supabaseClient = null;
        let isUploading = false;

        // Elements
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const viewUpload = document.getElementById('view-upload');
        const viewProgress = document.getElementById('view-progress');
        const viewResult = document.getElementById('view-result');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const resultLink = document.getElementById('result-link');
        const fileNameEl = document.getElementById('file-name');
        const fileSizeEl = document.getElementById('file-size');
        const historyList = document.getElementById('history-list');
        const emptyHistoryMsg = document.getElementById('empty-history');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            if (!SUPABASE_URL || !SUPABASE_KEY) {
                document.getElementById('config-warning').classList.remove('hidden');
                fileInput.disabled = true;
                dropZone.style.cursor = 'not-allowed';
            } else {
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            renderHistory();
        });

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files.length) handleFiles(e.target.files[0]);
        });

        async function handleFiles(file) {
            if (isUploading) return;
            if (!supabaseClient) return showToast('Config Supabase belum lengkap', 'error');

            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                return showToast('File kegedean (max 50MB)', 'error');
            }

            isUploading = true;
            dropZone.classList.add('uploading');

            updateView('progress');
            fileNameEl.textContent = file.name;
            fileSizeEl.textContent = formatBytes(file.size);
            updateProgressUI(0);

            const fileExt = file.name.includes('.') ? file.name.split('.').pop().toLowerCase() : 'bin';
            const uniqueName = `${crypto.randomUUID()}.${fileExt}`;
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(fileExt);

            let progressInterval;
            try {
                // Fake smooth progress for UX
                let fakeProg = 0;
                progressInterval = setInterval(() => {
                    if (fakeProg >= 90) {
                        fakeProg += (100 - fakeProg) * 0.1;
                    } else {
                        fakeProg += 3 + Math.random() * 5;
                    }
                    fakeProg = Math.min(fakeProg, 90);
                    updateProgressUI(fakeProg);
                }, 150);

                const { data, error } = await supabaseClient.storage
                    .from(BUCKET_NAME)
                    .upload(uniqueName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                clearInterval(progressInterval);

                if (error) throw error;

                updateProgressUI(100);

                const { data: urlData } = supabaseClient.storage
                    .from(BUCKET_NAME)
                    .getPublicUrl(uniqueName);

                const publicUrl = urlData.publicUrl;

                // Save to History
                saveToHistory({
                    name: file.name,
                    size: formatBytes(file.size),
                    url: publicUrl,
                    date: new Date().toLocaleString('id-ID'),
                    type: fileExt,
                    isImage: isImage
                });

                setTimeout(() => {
                    resultLink.value = publicUrl;
                    
                    // Handle Preview
                    if (isImage) {
                        previewContainer.classList.remove('hidden');
                        imagePreview.src = publicUrl;
                    } else {
                        previewContainer.classList.add('hidden');
                        imagePreview.src = '';
                    }

                    updateView('result');
                    showToast('Mantap, berhasil!', 'success');
                }, 600);

            } catch (err) {
                console.error('Upload failed:', err);
                clearInterval(progressInterval);
                let msg = 'Yah gagal... coba lagi';
                if (err.message?.includes('size')) msg = 'File kegedean bos';
                else if (err.message?.includes('permission')) msg = 'Izin ditolak (cek config)';
                showToast(msg, 'error');
                setTimeout(() => updateView('upload'), 2000);
            } finally {
                isUploading = false;
                dropZone.classList.remove('uploading');
            }
        }

        // ==========================================
        // HISTORY LOGIC
        // ==========================================
        function getHistory() {
            const h = localStorage.getItem('ar4upload_history');
            return h ? JSON.parse(h) : [];
        }

        function saveToHistory(item) {
            const h = getHistory();
            h.unshift(item); // Add to top
            if (h.length > 20) h.pop(); // Keep only last 20
            localStorage.setItem('ar4upload_history', JSON.stringify(h));
            renderHistory();
        }

        function deleteHistoryItem(index) {
            const h = getHistory();
            h.splice(index, 1);
            localStorage.setItem('ar4upload_history', JSON.stringify(h));
            renderHistory();
            showToast('Item dihapus', 'info');
        }

        function clearHistory() {
            if(confirm('Yakin mau hapus semua riwayat?')) {
                localStorage.removeItem('ar4upload_history');
                renderHistory();
                showToast('Riwayat bersih!', 'success');
            }
        }

        function renderHistory() {
            const h = getHistory();
            historyList.innerHTML = '';

            if (h.length === 0) {
                emptyHistoryMsg.classList.remove('hidden');
                return;
            }
            emptyHistoryMsg.classList.add('hidden');

            h.forEach((item, index) => {
                const iconClass = item.isImage ? 'fa-image text-purple-400' : 'fa-file-lines text-slate-400';
                const previewImg = item.isImage ? `<img src="${item.url}" class="w-8 h-8 rounded object-cover border border-slate-600">` : `<div class="w-8 h-8 rounded bg-slate-700 flex items-center justify-center"><i class="fas ${iconClass}"></i></div>`;

                const el = document.createElement('div');
                el.className = 'bg-slate-800/40 hover:bg-slate-800 p-3 rounded-xl border border-slate-700/50 flex items-center gap-3 transition-colors group';
                el.innerHTML = `
                    ${previewImg}
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-slate-200 truncate cursor-pointer hover:text-accent" onclick="window.open('${item.url}', '_blank')">${item.name}</p>
                        <p class="text-[10px] text-slate-500">${item.date} â€¢ ${item.size}</p>
                    </div>
                    <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
                        <button onclick="copyLink('${item.url}')" class="w-7 h-7 flex items-center justify-center rounded-lg bg-slate-700 hover:bg-accent hover:text-white text-slate-300 transition-colors" title="Copy Link">
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                        <button onclick="deleteHistoryItem(${index})" class="w-7 h-7 flex items-center justify-center rounded-lg bg-slate-700 hover:bg-red-500 hover:text-white text-slate-300 transition-colors" title="Hapus">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                `;
                historyList.appendChild(el);
            });
        }

        // ==========================================
        // COPY LINK (FIXED/ROBUST VERSION)
        // ==========================================
        async function copyLink(url) {
            try {
                // Cara Modern
                await navigator.clipboard.writeText(url);
                showToast('Link dicopy!', 'success');
            } catch (err) {
                // Cara Tradisional (Fallback)
                const textArea = document.createElement("textarea");
                textArea.value = url;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showToast('Link dicopy!', 'success');
                } catch (e) {
                    console.error('Copy failed', e);
                    showToast('Gagal copy otomatis', 'error');
                }
                
                document.body.removeChild(textArea);
            }
        }

        function copyToClipboard() {
            const url = resultLink.value;
            copyLink(url);
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function updateView(view) {
            [viewUpload, viewProgress, viewResult].forEach(v => v.classList.add('hidden'));
            if (view === 'upload') viewUpload.classList.remove('hidden');
            if (view === 'progress') viewProgress.classList.remove('hidden');
            if (view === 'result') viewResult.classList.remove('hidden');
        }

        function updateProgressUI(val) {
            const percent = Math.round(val);
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(decimals))} ${sizes[i]}`;
        }

        function resetApp() {
            fileInput.value = '';
            imagePreview.src = '';
            previewContainer.classList.add('hidden');
            updateProgressUI(0);
            updateView('upload');
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const icon = document.getElementById('toast-icon');

            msgEl.textContent = msg;
            icon.className = type === 'error' 
                ? 'fas fa-exclamation-circle text-red-400 text-lg' 
                : 'fas fa-check-circle text-green-400 text-lg';

            toast.classList.remove('-translate-y-24', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('-translate-y-24', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>
